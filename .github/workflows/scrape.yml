name: Run Scraper on EC2

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC

jobs:
  setup-dependencies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Install dependencies on EC2
        run: |
          echo "[INFO] Setting up dependencies on EC2..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            echo "[EC2] Syncing latest code..."
            cd ~/CommodiAI- && git pull origin main
            
            echo "[EC2] Activating virtual environment..."
            source venv/bin/activate
            
            echo "[EC2] Installing Python dependencies..."
            pip install -r scraper/requirements.txt
            
            echo "[EC2] Installing system dependencies..."
            sudo apt-get update -qq
            sudo apt-get install -y -qq \
              libatk1.0-0t64 \
              libatk-bridge2.0-0t64 \
              libcups2t64 \
              libatspi2.0-0t64 \
              libxcomposite1 \
              libxdamage1 \
              libxfixes3 \
              libxrandr2 \
              libgbm1 \
              libcairo2 \
              libpango-1.0-0 \
              libasound2t64
            
            echo "[EC2] Installing Playwright browsers..."
            python -m playwright install chromium
            
            echo "✅ [EC2] Dependencies setup completed"
          EOF

  run-scraper:
    runs-on: ubuntu-latest
    needs: setup-dependencies
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Run APMC Scraper
        run: |
          echo "[INFO] Running scraper on EC2..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            echo "[EC2] Starting scraper..."
            cd ~/CommodiAI-/scraper
            source ../venv/bin/activate
            python APMC_Scraper.py
            echo "✅ [EC2] Scraper completed at $(date)"
          EOF